import{$ as w,Ac as J,Bc as Z,Cc as $,K as v,a as h,b as Q,jc as Y,oc as d,qc as l,rc as q,tc as K,vc as b,wb as X,wc as C,x as W,xc as G}from"./chunk-4XV3WJIA.js";import{Db as U,Eb as j,Gb as T,Hb as A,Jb as N,La as S,Ob as I,S as R,Tb as p,Ub as a,Va as _,X as M,Yb as H,_b as F,aa as c,f as B,jb as D,ka as u,kb as V,la as E,m as O,pa as o,pb as g,qb as z,rb as y,ta as f,y as x}from"./chunk-UHC7VOKG.js";function ee(i=c(E)){let r=Promise.resolve();return t=>r=r.then(async()=>{try{await t()}catch(e){i.handleError(e)}})}function re(i,r){function t(e){let n=e;n.data==="ping"&&(n.target.send("pong"),r())}return i.addEventListener("message",t),G(()=>{i.removeEventListener("message",t),F()?i.state!=="closed"&&i.close():i.state!=="terminated"&&i.terminate()})}var m=class i{endpoint;calibrating=o(!1);calibration=o({resolution:1,x:1,y:1});mapViewCenter=o([0,0]);mapViewRotation=o(0);mapView=p(()=>new X({projection:K(),constrainRotation:!1,resolution:this.calibration().resolution,resolutions:[this.calibration().resolution],center:this.mapViewCenter(),rotation:this.mapViewRotation()}));mapBackgroundExtent=o(v());mapBackgroundViewData=o(null);mapBackgroundMaskData=o(null);mapBackgroundView=C(r=>{let t=this.mapBackgroundExtent(),e=this.mapBackgroundViewData();if(w(t)||!e)return null;let n=URL.createObjectURL(e);return r(()=>URL.revokeObjectURL(n)),new b({url:n,imageExtent:t})});mapBackgroundMask=C(r=>{let t=this.mapBackgroundExtent(),e=this.mapBackgroundMaskData();if(w(t)||!e)return null;let n=URL.createObjectURL(e);return r(()=>URL.revokeObjectURL(n)),new b({url:n,imageExtent:t})});constructor(){if(!navigator.presentation.receiver)throw new Error("Not in a presentation session");this.endpoint=$(O(navigator.presentation.receiver.connectionList).pipe(R(e=>new B(n=>{let k,L,P=s=>{L?.(),k=s,s?re(s,()=>{k===s&&n.next(s)}):n.next(void 0)};return P(e.connections.at(-1)),e.onconnectionavailable=({connection:s})=>P(s),()=>{e.onconnectionavailable=null,L?.()}})),h()));let r=o({width:window.innerWidth,height:window.innerHeight});x(window,"resize").pipe(h()).subscribe(()=>r.set({width:window.innerWidth,height:window.innerHeight})),a(()=>{let{width:e,height:n}=r();this.endpoint.send(l.serialize({type:"viewport:resize:native",width:e,height:n}))});let t=ee();this.endpoint.addListener(e=>t(async()=>{if(typeof e=="string"){if(e==="ping")return;console.error("Unexpected message",e)}if(e instanceof ArrayBuffer){let n=l.deserialize(new Uint8Array(e));switch(n.type){case"viewport:calibrate":{n.action==="start"&&this.calibrating.set(!0),n.action==="commit"&&(this.calibrating.set(!1),this.calibration.set(n.calibration));break}case"background:extent":{this.mapBackgroundExtent.set(n.extent?n.extent:v());break}case"background:push-view":{this.mapBackgroundViewData.set(n.image.byteLength?new Blob([new Uint8Array(n.image)]):null);break}case"background:push-mask":{this.mapBackgroundMaskData.set(n.image.byteLength?new Blob([new Uint8Array(await J(n.image))]):null);break}case"viewport:update":{this.mapViewCenter.set(n.center),this.mapViewRotation.set(n.rotation);break}default:{console.error("Unexpected message",n);break}}}}))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=M({token:i,factory:i.\u0275fac})};var ie=["view"];function oe(i,r){i&1&&(g(0,"div",2),y(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6),g(5,"div",7),N(6," Calibration "),z()())}var te=class i{viewRef=H.required("view",{read:f});viewSize=q(p(()=>this.viewRef()?.nativeElement));remote=c(m);mapTemporaryLayer=new d({className:"temporary-render-layer",opacity:0});mapBaseLayer=new d({className:"render-layer"});mapOverlayLayer=new d({className:"render-layer"});map=new Y({controls:[],interactions:[],layers:[this.mapTemporaryLayer,this.mapOverlayLayer,this.mapBaseLayer]});constructor(){a(()=>this.map.setTarget(this.viewRef()?.nativeElement)),a(()=>this.map.setView(this.remote.mapView())),Q(this.viewSize).subscribe(()=>this.map.updateSize()),c(u).onDestroy(()=>this.map.dispose()),a(()=>{let{width:t,height:e}=this.viewSize();this.remote.endpoint.send(l.serialize({type:"viewport:resize:virtual",width:t,height:e}))});let r=o(!1);a(()=>this.mapBaseLayer.setVisible(r())),a(()=>this.mapBaseLayer.setSource(this.remote.mapBackgroundView())),a(t=>{let e=this.remote.mapBackgroundMask();if(e){this.mapTemporaryLayer.setSource(e);let n=this.map.once("rendercomplete",()=>{r.set(!0),this.mapOverlayLayer.setSource(this.mapTemporaryLayer.getSource()),this.mapTemporaryLayer.setSource(null)});t(()=>W(n))}else r.set(!1),this.mapTemporaryLayer.setSource(null),this.mapOverlayLayer.setSource(null)}),c(u).onDestroy(()=>{this.mapBaseLayer.setSource(null),this.mapTemporaryLayer.setSource(null),this.mapOverlayLayer.setSource(null)}),this.mapOverlayLayer.on("prerender",t=>{let e=t.context;e.globalCompositeOperation="source-over"}),this.mapBaseLayer.on("prerender",t=>{let e=t.context;e.globalCompositeOperation="multiply"})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["ng-component"]],viewQuery:function(t,e){t&1&&U(e.viewRef,ie,5,f),t&2&&j()},hostVars:4,hostBindings:function(t,e){t&2&&T("--scaleX",e.remote.calibration().x)("--scaleY",e.remote.calibration().y)},features:[I([Z(()=>()=>!0),m])],decls:3,vars:3,consts:[["view",""],[1,"view"],[1,"calibration-view"],[1,"marker","top","right"],[1,"marker","top","left"],[1,"marker","bottom","left"],[1,"marker","bottom","right"],[1,"content"]],template:function(t,e){t&1&&(y(0,"div",1,0),D(2,oe,7,0,"div",2)),t&2&&(A("calibrating",e.remote.calibrating()),S(2),V(e.remote.calibrating()?2:-1))},styles:["[_nghost-%COMP%]{position:fixed;inset:0;background-color:#000;overflow:hidden}.view[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:calc(100vw / var(--scaleX));height:calc(100vh / var(--scaleY));transform-origin:top left;transform:scale(var(--scaleX),var(--scaleY))}.view.calibrating[_ngcontent-%COMP%]:not(.debug-background){visibility:hidden}.view.calibrating.debug-background[_ngcontent-%COMP%]{filter:invert(1)}.calibration-view[_ngcontent-%COMP%]{position:absolute;display:flex;align-items:center;justify-content:center;color:#fff;font-size:4rem;inset:0}.calibration-view[_ngcontent-%COMP%]   .marker[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);width:4rem;height:4rem;background-color:#fff;border-radius:50%}.calibration-view[_ngcontent-%COMP%]   .marker.top[_ngcontent-%COMP%]{top:0}.calibration-view[_ngcontent-%COMP%]   .marker.bottom[_ngcontent-%COMP%]{top:100%}.calibration-view[_ngcontent-%COMP%]   .marker.left[_ngcontent-%COMP%]{left:0}.calibration-view[_ngcontent-%COMP%]   .marker.right[_ngcontent-%COMP%]{left:100%}"]})};export{te as RemotePageComponent};
