import{$ as b,Ac as J,Bc as Z,Cc as $,K as h,a as y,b as Q,jc as Y,oc as d,qc as m,rc as q,tc as K,vc as w,wb as X,wc as k,x as W,xc as G}from"./chunk-FZEC7TFF.js";import{Kb as z,Lb as U,Ma as R,Nb as j,O as x,Ob as T,Qb as A,U as D,Wb as I,Z as c,Za as S,bc as p,fc as H,g as P,ha as u,hc as F,l as B,la as O,lb as V,mb as _,oa as i,qa as o,ua as g,ub as f,vb as N,wb as v,x as E}from"./chunk-O6EHPXKY.js";function ee(a=c(O)){let r=Promise.resolve();return t=>r=r.then(async()=>{try{await t()}catch(e){a.handleError(e)}})}function re(a,r){function t(e){let n=e;n.data==="ping"&&(n.target.send("pong"),r())}return a.addEventListener("message",t),G(()=>{a.removeEventListener("message",t),F()?a.state!=="closed"&&a.close():a.state!=="terminated"&&a.terminate()})}var l=class a{endpoint;calibrating=i(!1);calibration=i({resolution:1,x:1,y:1});mapViewCenter=i([0,0]);mapViewRotation=i(0);mapView=p(()=>new X({projection:K(),constrainRotation:!1,resolution:this.calibration().resolution,resolutions:[this.calibration().resolution],center:this.mapViewCenter(),rotation:this.mapViewRotation()}));mapBackgroundExtent=i(h());mapBackgroundViewData=i(null);mapBackgroundMaskData=i(null);mapBackgroundView=k(r=>{let t=this.mapBackgroundExtent(),e=this.mapBackgroundViewData();if(b(t)||!e)return null;let n=URL.createObjectURL(e);return r(()=>URL.revokeObjectURL(n)),new w({url:n,imageExtent:t})});mapBackgroundMask=k(r=>{let t=this.mapBackgroundExtent(),e=this.mapBackgroundMaskData();if(b(t)||!e)return null;let n=URL.createObjectURL(e);return r(()=>URL.revokeObjectURL(n)),new w({url:n,imageExtent:t})});constructor(){if(!navigator.presentation.receiver)throw new Error("Not in a presentation session");this.endpoint=$(B(navigator.presentation.receiver.connectionList).pipe(x(e=>new P(n=>{let C,L,M=s=>{L?.(),C=s,s?re(s,()=>{C===s&&n.next(s)}):n.next(void 0)};return M(e.connections.at(-1)),e.onconnectionavailable=({connection:s})=>M(s),()=>{e.onconnectionavailable=null,L?.()}})),y()));let r=i({width:window.innerWidth,height:window.innerHeight});E(window,"resize").pipe(y()).subscribe(()=>r.set({width:window.innerWidth,height:window.innerHeight})),o(()=>{let{width:e,height:n}=r();this.endpoint.send(m.serialize({type:"viewport:resize:native",width:e,height:n}))});let t=ee();this.endpoint.addListener(e=>t(async()=>{if(typeof e=="string"){if(e==="ping")return;console.error("Unexpected message",e)}if(e instanceof ArrayBuffer){let n=m.deserialize(new Uint8Array(e));switch(n.type){case"viewport:calibrate":{n.action==="start"&&this.calibrating.set(!0),n.action==="commit"&&(this.calibrating.set(!1),this.calibration.set(n.calibration));break}case"background:extent":{this.mapBackgroundExtent.set(n.extent?n.extent:h());break}case"background:push-view":{this.mapBackgroundViewData.set(n.image.byteLength?new Blob([new Uint8Array(n.image)]):null);break}case"background:push-mask":{this.mapBackgroundMaskData.set(n.image.byteLength?new Blob([new Uint8Array(await J(n.image))]):null);break}case"viewport:update":{this.mapViewCenter.set(n.center),this.mapViewRotation.set(n.rotation);break}default:{console.error("Unexpected message",n);break}}}}))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=D({token:a,factory:a.\u0275fac})};var ae=["view"];function ie(a,r){a&1&&(f(0,"div",2),v(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6),f(5,"div",7),A(6," Calibration "),N()())}var te=class a{viewRef=H.required("view",{read:g});viewSize=q(p(()=>this.viewRef()?.nativeElement));remote=c(l);mapTemporaryLayer=new d({className:"temporary-render-layer",opacity:0});mapBaseLayer=new d({className:"render-layer"});mapOverlayLayer=new d({className:"render-layer"});map=new Y({controls:[],interactions:[],layers:[this.mapTemporaryLayer,this.mapOverlayLayer,this.mapBaseLayer]});constructor(){o(()=>this.map.setTarget(this.viewRef()?.nativeElement)),o(()=>this.map.setView(this.remote.mapView())),Q(this.viewSize).subscribe(()=>this.map.updateSize()),c(u).onDestroy(()=>this.map.dispose()),o(()=>{let{width:t,height:e}=this.viewSize();this.remote.endpoint.send(m.serialize({type:"viewport:resize:virtual",width:t,height:e}))});let r=i(!1);o(()=>this.mapBaseLayer.setVisible(r())),o(()=>this.mapBaseLayer.setSource(this.remote.mapBackgroundView())),o(t=>{let e=this.remote.mapBackgroundMask();if(e){this.mapTemporaryLayer.setSource(e);let n=this.map.once("rendercomplete",()=>{r.set(!0),this.mapOverlayLayer.setSource(this.mapTemporaryLayer.getSource()),this.mapTemporaryLayer.setSource(null)});t(()=>W(n))}else r.set(!1),this.mapTemporaryLayer.setSource(null),this.mapOverlayLayer.setSource(null)}),c(u).onDestroy(()=>{this.mapBaseLayer.setSource(null),this.mapTemporaryLayer.setSource(null),this.mapOverlayLayer.setSource(null)}),this.mapOverlayLayer.on("prerender",t=>{let e=t.context;e.globalCompositeOperation="source-over"}),this.mapBaseLayer.on("prerender",t=>{let e=t.context;e.globalCompositeOperation="multiply"})}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=S({type:a,selectors:[["ng-component"]],viewQuery:function(t,e){t&1&&z(e.viewRef,ae,5,g),t&2&&U()},hostVars:4,hostBindings:function(t,e){t&2&&j("--scaleX",e.remote.calibration().x)("--scaleY",e.remote.calibration().y)},features:[I([Z(()=>()=>!0),l])],decls:3,vars:3,consts:[["view",""],[1,"view"],[1,"calibration-view"],[1,"marker","top","right"],[1,"marker","top","left"],[1,"marker","bottom","left"],[1,"marker","bottom","right"],[1,"content"]],template:function(t,e){t&1&&(v(0,"div",1,0),V(2,ie,7,0,"div",2)),t&2&&(T("calibrating",e.remote.calibrating()),R(2),_(e.remote.calibrating()?2:-1))},styles:["[_nghost-%COMP%]{position:fixed;inset:0;background-color:#000;overflow:hidden}.view[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:calc(100vw / var(--scaleX));height:calc(100vh / var(--scaleY));transform-origin:top left;transform:scale(var(--scaleX),var(--scaleY))}.view.calibrating[_ngcontent-%COMP%]:not(.debug-background){visibility:hidden}.view.calibrating.debug-background[_ngcontent-%COMP%]{filter:invert(1)}.calibration-view[_ngcontent-%COMP%]{position:absolute;display:flex;align-items:center;justify-content:center;color:#fff;font-size:4rem;inset:0}.calibration-view[_ngcontent-%COMP%]   .marker[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);width:4rem;height:4rem;background-color:#fff;border-radius:50%}.calibration-view[_ngcontent-%COMP%]   .marker.top[_ngcontent-%COMP%]{top:0}.calibration-view[_ngcontent-%COMP%]   .marker.bottom[_ngcontent-%COMP%]{top:100%}.calibration-view[_ngcontent-%COMP%]   .marker.left[_ngcontent-%COMP%]{left:0}.calibration-view[_ngcontent-%COMP%]   .marker.right[_ngcontent-%COMP%]{left:100%}"]})};export{te as RemotePageComponent};
